# TOAD

## Running TOAD

Once the imaging data is converted, you simply have to run the command 'toad' from the folder that contains the converted files:

~~~bash
# Go to the data-containing folder
cd toad_data

# Run TOAD
toad .
~~~

Data preprocessing for one participant takes about 2 days to complete. 
Parallel processing of multiple participants or a large dataset is also possible on the UNF servers, depending on their work load at the given time. 

## Verifications

### Analysis in progress

One can check the progress of the preprocessing (e.g. how many subjects have been preprocessed) on the UNF servers by typing the command 'qstat -f'.

If your analyses are ongoing, you should be able to see your username associated with the name of the participant being analyzed and with the software being used at the moment (e.g. FreeSurfer).

During processing, you can use the following command to check the quality of the different stages as they are being completed: `firefox 00-qa/index.html` (see below).

### Post processing

Once the work is finished, you will find a new set of folders in each participant’s directory.
*Reminder*, by default, this folder is located in the initial project folder `toad_data`, or the folder you specified during the data conversion with `dcm2toad`.

These folders contain the dataset, masks, and images generated by the TOAD preprocessing pipeline. The results can be quickly verified thanks to QA.
The set of folders for each participant should ressemble the following table:

|**Folder name**        | **Type of data**                                      |
|-----------------------|-------------------------------------------------------|
|00-backup              | Raw data (Nifti)            		                |
|00-qa                  | Quality Assessment - HTML summary pages               |
|01-preparation         | Image reorientation, if necessary	                |
|02-parcellation        | Parseg and Brodmann, left/right (Freesurfer)          |
|03-atlas               | Generation and application of atlases                 |
|04-denoising           | Image denoising                                 	|
|05-correction          | Motion correction, field inhomogeneity, etc.	        |
|05-preprocessing       |                                                       |
|06-upsampling          | Resolution upsampling	                                |
|07-registration        | Registration T1/DWI                                   |
|08-atlasregistration   |                                                       |
|09-masking             | Mask generation                   	                |
|08-snr                 | Signal to noise ratio calculation    	                |
|10-tensorfsl           | Tensor reconstruction (FSL)                 	        |
|11-tensormrtrix        | Tensor reconstruction (MRTRIX)           	        |
|12-tensordipy          | Tensor reconstruction (Dipy)                    	|
|13-hardimrtrix         | HARDI reconstruction  (MRTRIX)                        |
|14-hardidipy           | HARDI reconstruction (Dipy)                           |
|15-tractographymrtrix  | Fiber tract reconstruction (MRTRIX)          	        |
|16-tractographydipy    | Fiber tract reconstruction (Dipy)      	        |
|17-snr                 | Signal to noise ratio calculation                     |
|18-outputs             | Regroups all data outputs (denoised and resampled images, tensors, fiber tracts, ...) |                                                   |
|99-logs                | Log and error files                          			

*Note:* This organisation may change with the different versions of TOAD. Furthermore, the choice of certain parameters at the beginning of the pipeline, or the absence of certain files (e.g. B0 AP/PA) means certain tasks will not be executed.

The first step to verify that all analyses ran smoothly is to check that these folders have been generated for each participant. 
The absence of a series of folders indicates that the pipeline encountered a problem and stopped for the participant in question.

If that is the case, one may want to consult the last log file generated by TOAD.
This file, `*.log`, will be located in the last folder created by TOAD, or in `99-logs`.
This folder also contains a file such as `number_subject.e1111` (where 1111 corresponds to processing number attributed to the task) that combines all errors encountered during TOAD processing.

Results can be quickly verified thanks to the QA.

### Quality Assessment

TOAD offers a simple yet complete interface to explore data quality and the results obtained.

To start the QA, open a web browser using the command `firefox 00-qa/index.html`.
After some time, the browser will load a page containing different images associated with the QA.

*Warning:* for the command to work, the SSH session had to be launched with `-Y`to allow for graphics. 

~~~bash
ssh -Y username@stark.criugm.qc.ca
~~~

The browser will open a welcome page that contains a link to each completed task.
You will also find the main parameters and images necessary to evaluate data quality and check for proper pipeline functioning.

For example, you can observe the effect of the correction with before/after images, look at the signal to noise ratio, etc.

In case of errors, you fill find more information in the log folder situated in each task’s folder.

~~~bash
# Replace 'toad_data' with the name of the folder used during the conversion 
cd toad_data/subject_name/99-logs

# List available logs 
ls

# To check a log file (results.log in this case)
vi results.log
~~~

# Advanced usage in case of an error

## TOAD options

It is possible to check for different TOAD options by simply typing `toad` in the terminal.
You will see a list of options to be added to TOAD to run certain tasks, to add certain parameters, or to avoid different steps.

The two following command lines may be particularly helpful.

## Run TOAD for a single participant

`toad foldername` where 'foldername' is the name of the participant’s folder

## Reset data

TOAD saves all raw data (following the `dcm2toad` conversion, for example), and can return to this stage by using the command: `toad -r .`.

You can also reset the data of a single participant using the command: `toad -r foldername` where 'foldername' is the name of the participant’s folder.

## Error example

You may encounter errors during data processing. For example, the default algorithm used (NLMEANS) may not be compatible with your dataset.
In this case, even though the analysis will start running, it will need to be terminated. 

To do this, open the terminal at the location of your work folder:

1. Check whether there are ongoing analyses using the command: `qstat -f`
2. Stop the analysis in progress per participant using the command: `qdel #id` where "#id" corresponds to the processing number attributed by qstat.
3. Reset to the original data using the command: `toad -r .`
A warning will appear stating the process is locked. You will need to select `r` and confirm so that TOAD removes this lock to reset the data.
4. Change the necessary information in your data or in the configuration file (e.g. add a file "config.cfg" in the work folder with the option `algorithm=lpca` in the `[denoising]` section).
5. Restart TOAD using the command `toad .`

For more information, **consult the documentation** available for each task in the TOAD pipeline.

